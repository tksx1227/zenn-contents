---
title: "TLS証明書について理解した上でlocalhost上でHTTPS通信を行う"
emoji: "🔐️"
type: "tech"
topics: ["TLS", "HTTPS"]
published: false
---

# はじめに
こんにちは。都内でエンジニアをしているtomoriです。

皆さんはTLSについてどこまで理解できていますか？

恥ずかしながら、僕は「TLS？ああ、HTTPS通信のあれね。通信を暗号化するってやつね。」というふわっとした理解しかできていませんでした。

というわけで、TLSについてもっとちゃんと理解したいと思い、自分なりにインプットし直す機会があったため、そのアウトプットを兼ねて記事にします。

同じような境遇の方のお役に立てれば嬉しいです。

記事内に誤り等ございましたら、ご指摘いただけますと幸いです。

:::message
なおTLSに関する記事は２つのパートで構成予定であり、本記事はTLS証明書に焦点を当てた内容となっています。
:::

## 目的
本記事は、TLSについて座学としてインプットしたことを実務に活かす前段として、実際にサーバーと証明書を用意してみて学んだ通りのことが起きているのかを自分で確認する、ということを目的としています。

具体的には、以下の内容を通して「ふむふむ。実際に座学として学んだ通りのことが行われてるんだな。」と思える状態を目指します。

1. localhost上にNginxサーバーを起動する
2. 証明書を発行し、サーバーに設定する
3. ルート証明書を発行し、Macのキーチェーンに設定する
4. サーバーとHTTPS通信ができることを確認する
5. パケットキャプチャを通して、より具体的に通信を追ってみる

:::message
今回扱う証明書は自己署名証明書になります。
実際に公認のCAに証明書を承認してもらうための手続きについては触れません。
:::

## 対象読者
本記事は以下に当てはまる方を対象にしています。

- TLSについて「ああ、あれね。通信を暗号化する技術ね。」とふわっと理解している方
- TLSについて座学として理解してはいるものの、実際にやり取りされるデータまで見たことがない方
- localhostとHTTPS通信してみたい方

## 使用する環境・ツールなど
- PC：M1 Macbook Air
- ブラウザ：Chrome
- サーバー：Nginx
- コンテナエンジン：Docker
- 鍵作成ツール：OpenSSL
- パケットキャプチャツール：Wireshark

# TLS証明書とは
TLS（Transport Layer Security）証明書とは、サーバーが自分自身を正規のサーバーであることを証明し、暗号化された通信を可能にするためのデジタル証明書です。

これは信頼された第三者機関（CA、証明書認証局）によって発行され、サーバーの公開鍵、発行者の情報、有効期間などを含んでいます。

Chromeではアドレスバーの左にあるボタンから、そのサーバーが発行する証明書の情報を確認することができます。

![](/images/tls/img.png)
*zenn.devのTLS証明書*

画像から分かるように、これは ”GTS CA 1P5” という認証局が ”zenn.dev” に対して発行した証明書となります。

例えば、証明書をクライアントに送信したサーバーのドメインと、証明書に記載された「発行先」が異なる値となっていた場合、ブラウザは証明書を無効とみなし、そのドメインを安全ではないサイトとして扱うようになります。

![](/images/tls/img0.png)
*Chromeに安全ではないと認識されたサイト*

以降でもう少し詳細を確認してみます。

## 証明書の構成要素
証明書はおおよそ以下の要素によって構成されています。

- DN (Distinguished Name)
  - 発行元情報（Issuer DN）
  - 発行先情報（Subject DN）
- 公開鍵
- 有効期限
- シリアルナンバー
- 署名アルゴリズム
- 発行者の署名

重要な項目をピックアップして説明します。

### DN (Distinguished Name)
DNは証明書の識別子を表す用語であり、証明書の主体（Subject）と発行者（Issuer）の身元を識別するための属性です。

TLS証明書には証明書の所有者（Subject DN）と発行する認証局（Issuer DN）の両方のDNが含まれます。

また、認証局のポリシーに応じてDNには様々な情報が含まれます。

以下が一般的にDNに含まれる情報です。

- CN (Certificate owner's common name) : 共通名
- O (Organization) : 組織
- OU (Organizational unit) : 組織単位
- L (Locality or city) : 地域または市
- ST (State or province) : 州または県
- C (Country or region) : 国または地域

証明書に含まれるSubject DNのうちCNは特に重要な項目です。

ここにはサーバーがホストされるドメインが記載されている必要があり、CNの値と実際にホストされるサーバーのドメイン名が異なる場合、ブラウザはそのサイトを安全ではないと認識する可能性があります（上の画像を参考）。

:::message
上記の情報はすべての項目が必須というわけではなく、CNのみ指定されているような証明書も存在します。また、証明書を発行する認証局によって含めることができる情報が変動することがあります。
:::

### 公開鍵

### 有効期限
証明書が有効なものとして扱われる期限です。

### 発行者の署名
サーバーが所有するTLS証明書には、その証明書の発行元である認証局の署名が含まれています。

この署名により、証明書が認証局から発行されたことが担保されます。

こちらは後述する証明書発行フローで改めて説明します。

## 証明書発行フロー
まずは単純なケースとしてサーバーと認証局が１つずつある場合で説明します。

証明書は以下のフローに沿って ”信頼された第三者機関（CA、証明書認証局）” により発行されます。

1. サーバー：公開鍵と秘密鍵のキーペアを作成する。
2. サーバー：CSR^[Certificate Signing Request：TLSサーバー証明書を発行するための証明書署名要求のこと]を作成し、それを認証局に提出する。この時、１で作成したキーペアのうち公開鍵をCSRに含める。
3. 認証局：CSRの内容を検証し、サーバーの身元確認等を行なった上で、CSRに含まれる公開鍵とサーバーの情報を用いて証明書を作成し、その証明書に自身の秘密鍵でデジタル署名を行う。
4. サーバー：認証局から受け取った証明書を自身のサーバーに設定し、クライアントが接続した際にそれを提供するようにする。

単純なケースとして `tksx1227.example.com` に対して信頼された認証局が直接証明書を発行する場合を考えます。

## 証明書の検証

## 証明書チェーン

# Nginxコンテナ起動

# 証明書発行

# 証明書のインストール
先ほど作成した証明書をホスト側にインストールします。

インストールは下記の手順で行うことができます。

1. 画面上部の四角ボタンをクリック
![](/images/tls/img1.png)

2. 作成した証明書を選択
![](/images/tls/img2.png)
証明書が取り込めたらクリックして詳細を開きます。
![](/images/tls/img3.png)

3. 証明書の設定変更
自前で登録した証明書は、デフォルトだとブラウザ側に信頼されていません。
そのため強制的に信頼してもらうように設定を変更します。
「この証明書を使用するとき」の項目を「常に信頼」に変更し、ウィンドウを閉じれば設定が更新されます。
![](/images/tls/img4.png)

# 動作確認

# おわりに

# 参考資料
- https://www.ibm.com/docs/en/i/7.5?topic=concepts-distinguished-name

# めも
証明書 = 公開鍵に多数のメタデータが付与されたデータ
