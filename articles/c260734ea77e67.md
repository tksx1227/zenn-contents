---
title: "TLS証明書について理解した上でlocalhost上でHTTPS通信を行う"
emoji: "🔐️"
type: "tech"
topics: ["TLS", "HTTPS"]
published: false
---

# はじめに
こんにちは。都内でエンジニアをしているtomoriです。

皆さんはTLSについてどこまで理解できていますか？

恥ずかしながら、僕は「TLS？ああ、HTTPS通信のあれね。通信を暗号化するってやつね。」というふわっとした理解しかできていませんでした。

というわけで、TLSについてもっとちゃんと理解したいと思い、自分なりにインプットし直す機会があったため、そのアウトプットを兼ねて記事にします。

同じような境遇の方のお役に立てれば嬉しいです。

記事内に誤り等ございましたら、ご指摘いただけますと幸いです。

:::message
なおTLSに関する記事は２つのパートで構成予定であり、本記事はTLS証明書に焦点を当てた内容となっています。
:::

## 目的
本記事は、TLSについて座学としてインプットしたことを実務に活かす前段として、実際にサーバーと証明書を用意してみて学んだ通りのことが起きているのかを自分で確認する、ということを目的としています。

具体的には、以下の内容を通して「ふむふむ。実際に座学として学んだ通りのことが行われてるんだな。」と思える状態を目指します。

1. localhost上にNginxサーバーを起動する
2. 証明書を発行し、サーバーに設定する
3. ルート証明書を発行し、Macのキーチェーンに設定する
4. サーバーとHTTPS通信ができることを確認する
5. パケットキャプチャを通して、より具体的に通信を追ってみる

:::message
今回扱う証明書は自己署名証明書になります。
実際に公認のCAに証明書を承認してもらうための手続きについては触れません。
:::

## 対象読者
本記事は以下に当てはまる方を対象にしています。

- TLSについて「ああ、あれね。通信を暗号化する技術ね。」とふわっと理解している方
- TLSについて座学として理解してはいるものの、実際にやり取りされるデータまで見たことがない方
- localhostとHTTPS通信してみたい方

## 使用する環境・ツールなど
- PC：M1 Macbook Air
- ブラウザ：Chrome
- サーバー：Nginx
- コンテナエンジン：Docker
- 鍵作成ツール：OpenSSL
- パケットキャプチャツール：Wireshark

# TLS証明書とは
TLS（Transport Layer Security）証明書とは、サーバーが自分自身を正規のサーバーであることを証明し、暗号化された通信を可能にするためのデジタル証明書です。

これは信頼された第三者機関（CA、証明書認証局）によって発行され、サーバーの公開鍵、発行者の情報、有効期間などを含んでいます。

Chromeではアドレスバーの左にあるボタンから、そのサーバーが発行する証明書の情報を確認することができます。

![](/images/tls/img.png)
*zenn.devのTLS証明書*

画像から分かるように、これは ”GTS CA 1P5” という認証局が ”zenn.dev” に対して発行した証明書となります。

例えば、証明書をクライアントに送信したサーバーのドメインと、証明書に記載された「発行先」が異なる値となっていた場合、ブラウザは証明書を無効とみなし、そのドメインを安全ではないサイトとして扱うようになります。

![](/images/tls/img0.png)
*Chromeに安全ではないと認識されたサイト*

以降でもう少し詳細を確認してみます。

## 証明書の構成要素
証明書はおおよそ以下の要素によって構成されています。

- DN (Distinguished Name)
  - 発行元情報（Issuer DN）
  - 発行先情報（Subject DN）
- 公開鍵
- 有効期限
- シリアルナンバー
- 署名アルゴリズム
- 発行者の署名

重要な項目をピックアップして説明します。

### DN (Distinguished Name)
DNは証明書の識別子を表す用語であり、証明書の主体（Subject）と発行者（Issuer）の身元を識別するための属性です。

TLS証明書には証明書の所有者（Subject DN）と発行する認証局（Issuer DN）の両方のDNが含まれます。

また、認証局のポリシーに応じてDNには様々な情報が含まれます。

以下が一般的にDNに含まれる情報です。

- CN (Certificate owner's common name) : 共通名
- O (Organization) : 組織
- OU (Organizational unit) : 組織単位
- L (Locality or city) : 地域または市
- ST (State or province) : 州または県
- C (Country or region) : 国または地域

証明書に含まれるSubject DNのうちCNは特に重要な項目です。

ここにはサーバーがホストされるドメインが記載されている必要があり、CNの値と実際にホストされるサーバーのドメイン名が異なる場合、ブラウザはそのサイトを安全ではないと認識する可能性があります（上の画像を参考）。

:::message
上記の情報はすべての項目が必須というわけではなく、CNのみ指定されているような証明書も存在します。また、証明書を発行する認証局によって含めることができる情報が変動することがあります。
:::

### 公開鍵

### 有効期限
証明書が有効なものとして扱われる期限です。

### 発行者の署名
サーバーが所有するTLS証明書には、その証明書の発行元である認証局の署名が含まれています。

この署名により、証明書が認証局から発行されたこと、およびその内容が改竄されていないことの両方が担保されます。

こちらは後述する証明書の発行で改めて説明します。

## 証明書の発行
サーバー側に設定する証明書を発行するフローを確認します。

まずは単純なケースとしてサーバーと認証局が１つずつある場合で説明します。

:::message
後ほど説明しますが、一般的に証明書の発行には２つ以上の認証局が連なっており。ここでの例のように最上位に位置する認証局はルート認証局と呼ばれています。
:::

証明書は「認証局が所有する証明書」と「サーバー側が所有する証明書」の２種類が登場するので、順番に説明します。

まずは認証局が所有する証明書の発行手順です。

証明書は以下のフローに沿って ”信頼された第三者機関（CA、証明書認証局）” により発行されます。

1. サーバー：公開鍵と秘密鍵のキーペアを作成する。
2. サーバー：CSR^[Certificate Signing Request：TLSサーバー証明書を発行するための証明書署名要求のこと]を作成し、それを認証局に提出する。この時、１で作成したキーペアのうち公開鍵をCSRに含める。
3. 認証局：CSRの内容を検証し、サーバーの身元確認等を行なった上で、CSRに含まれる公開鍵とサーバーの情報を用いて証明書を作成し、その証明書に自身の秘密鍵でデジタル署名を行う。
4. 認証局：署名を行った証明書をサーバーに引き渡す。
5. サーバー：認証局から受け取った証明書を自身のサーバーに設定し、クライアントが接続した際にそれを提供するようにする。
6. サーバー：クライアントと接続するたび証明書を引き渡す。

図で表すと以下のようになります。

![](/images/tls/img5.png)
*証明書発行フロー*

:::message alert
実際は認証局とサーバー間の通信は双方向ではなく、サーバーから認証局への一方通行であることに注意します。
:::

上記フローにてサーバー側がクライアントに証明書を渡すことができるようになりました。

続けてクライアント側の証明書の検証フローを見ていきます。

## 証明書の検証
クライアントでは以下のフローによって証明書の検証が行われます。

1. クライアント：サーバーにコネクションをリクエストする。
2. サーバー：設定された証明書をクライアントに送信する。
3. クライアント：証明書の有効期限を検証する。
4. クライアント：証明書が信頼できる認証局から発行されたものかどうかを確認する。
5. クライアント：証明書に添付された署名が認証局の公開鍵によって正しく検証されることを確認する。
6. クライアント：署名の検証が成功し、証明書が有効であると確認できたら、セキュアな接続を開始する。

こちらも図で表すと以下のようになります。

![](/images/tls/img6.png)
*証明書検証フロー*

上記フローの中で、４と５が重要になるので詳細を説明します。

４の「証明書が信頼できる認証局から発行されたものかどうかを確認する」ために、皆さんがお使いのホストには、予め信頼する認証局のリストとその認証局が持つ証明書が保存されています。

:::message
ChromeやMacOSが信頼している認証局のリストは下記リンク先から確認することができます。
Macではキーチェーンアクセスから下記リストに載っている認証局の証明書がローカル内に存在することが確認できます。
- https://chromium.googlesource.com/chromium/src/+/main/net/data/ssl/chrome_root_store/root_store.md
- https://support.apple.com/ja-jp/103425
:::

クライアントはサーバーから証明書を受け取った後、その証明書の発行元がホスト側に保存されている「信頼している認証局のリスト」の中に含まれるかを確認^[実際は発行元ではなく、証明書チェーンのルート認証局がホスト側に保存されているかを確認します]し、それによって ”信頼できる認証局から発行されたものかどうか” を検証します。

サーバー証明書が信頼している認証局から発行されていた場合、ホスト内にある該当した証明書から公開鍵を取り出し５の署名の検証を行います。

サーバー証明書を発行する際に認証局が持つ秘密鍵を使用してデジタル署名を行っていたため、その認証局が持つ証明書（公開鍵）を使用することで署名の検証が可能となります。

## 証明書チェーン

# Nginxコンテナ起動

# 証明書発行

# 証明書のインストール
先ほど作成した証明書をホスト側にインストールします。

インストールは下記の手順で行うことができます。

1. 画面上部の四角ボタンをクリック
![](/images/tls/img1.png)

2. 作成した証明書を選択
![](/images/tls/img2.png)
証明書が取り込めたらクリックして詳細を開きます。
![](/images/tls/img3.png)

3. 証明書の設定変更
自前で登録した証明書は、デフォルトだとブラウザ側に信頼されていません。
そのため強制的に信頼してもらうように設定を変更します。
「この証明書を使用するとき」の項目を「常に信頼」に変更し、ウィンドウを閉じれば設定が更新されます。
![](/images/tls/img4.png)

# 動作確認

# おわりに

# 参考資料
- https://www.ibm.com/docs/en/i/7.5?topic=concepts-distinguished-name

# めも
証明書 = 公開鍵に多数のメタデータが付与されたデータ
